<html>

<head>
    <meta charset="utf-8" />
    <title>BookManga</title>
    <script src="js/apiJS.js"></script>
    <script src="js/apiAirtable.js"></script>
    <link rel="stylesheet" href="css/w3.css">

    <style>
        html {
            background-color: gray;

        }

        * {
            font-size: large;
        }

        button {
            /*font-size: large;*/
            font-size: medium;
        }
        button:checked {
            background-color: rgb(0, 166, 255);
        }
         

        a {
            font-size: small;
        }


        #data td.last_modif {
            font-size: small;
            min-width: 5%;
            white-space: pre
        }

        table,
        td,
        th {
            border: 1px solid;

        }

        #data td {
            font-size: x-large;
        }

        table {
            border-collapse: collapse;
            background-color: lightgrey;
        }

        #f_add>textarea {
            width: 30%;
            font-size: x-large;
        }


        #co {
            background-color: rgba(255, 255, 0, 0.514);
        }

        #f_add {
            background-color: rgba(249, 10, 217, 0.605);
        }

        #f_filter {
            background-color: rgba(0, 255, 255, 0.326);
        }

        #update {
            background-color: rgba(128, 0, 128, 0.52);
        }



        #update td>textarea {
            width: 90%;
            font-size: x-large;
        }

        #update #up_id {
            width: 5%;
            font-size: small;
        }



        #data {
            background-color: rgba(81, 144, 81, 0.527);
        }
    </style>
</head>


<body>
    <div class="w3-bar w3-black">
        <button id="b_deco" onclick="show_nodel('co')">CONNECTION</button>
        <button id="add" onclick="show_nodel('f_add')">add</button>
        <button id="list" onclick="show_nodel('f_filter')">list</button>
    </div>

    <div>

        <div id="co" class="w3-modal" hidden>
            <div class="w3-modal-content">
                <div class="w3-container">
                    <span onclick="hidden_nodel('co')" class="w3-button w3-bar w3-red">&times;</span>
                    <input type="text" id="login" />
                    <input type="password" id="mdp" />
                    <button onclick="connection()">CONNECTION</button>
                    <button onclick="hidden_nodel('co')">ANNULER</button>
                </div>
            </div>
        </div>

    </div>
    </div>

    <div>

        <div id="f_add" class="w3-modal" hidden>
            <div class="w3-modal-content">
                <div class="w3-container">

                    <span onclick="hidden_nodel('f_add')" class="w3-button w3-bar  w3-red">&times;</span>
                    <div class="w3-container">
                        <textarea  class="w3-input erasable" type="textarea" placeholder="titre" id="titre"
                            required></textarea>
                        <textarea class="w3-input erasable" placeholder="option" id="add_option" required></textarea>
                        <textarea class="w3-input erasable" id="lien" placeholder="url" required></textarea>
                        <button class="w3-bar w3-green" style="width:40%" onclick="b_add(); hidden_nodel('f_add');">add</button>
                        <button class="w3-bar w3-yellow" style="width:40%" onclick="reset('f_add')">rest</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div>

        <div id="f_filter" class="w3-modal" hidden>
            <div class="w3-modal-content">
                <div class="w3-container">
                    <span onclick="hidden_nodel('f_filter')" class="w3-button w3-bar  w3-red" >&times;</span>
                    <div>
                        <textarea class="erasable w3-bar" type="textarea" id="search"></textarea>
                        <div>
                            <select style="width:40%" id="andor">
                                <option value="AND">AND</option>
                                <option value="OR">OR</option>
                            </select>
                            <select style="width:40%" id="sort">
                                <option value="desc" selected>last</option>
                                <option value="asc">old</option>
                            </select>
                        </div>
                        <div>
                            <button class="w3-bar w3-green" style="width:40%" onclick="b_search(); hidden_nodel('f_filter')">search</button>
                            <button class="w3-bar w3-yellow" style="width:40%" onclick="reset('f_filter')">rest</button>
                        </div>
                    </div>
                    <div>
                        <button style="width:10%" onclick="f_all(); hidden_nodel('f_filter')">ALL</button>
                        <button style="width:10%" onclick="one(); hidden_nodel('f_filter')">ONE</button>
                        <button style="width:10%" onclick="my_sort('desc'); hidden_nodel('f_filter')">last</button>
                        <button style="width:10%" onclick="my_sort('asc'); hidden_nodel('f_filter')">old</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="update" class="w3-modal" hidden>
        <div class="w3-modal-content">
            <div class="w3-container">
                <span onclick="hidden_nodel('update')" class="w3-button w3-bar w3-red">&times;</span>


                <div class="w3-container">

                    <label>ID</label>
                    <div id="up_id">ID</div>

                    <label>Name</label>
                    <div><textarea class="w3-input" type="textarea" placeholder="titre" id="up_titre"
                            required></textarea>
                        <button class="w3-bar w3-green" onclick="up_titre()">M</button>
                    </div>
                    <label>urls</label>
                    <div><textarea class="w3-input" type="textarea" placeholder="url" id="up_lien" required></textarea>
                        <button class="w3-bar w3-green" onclick="up_lien()">M</button>
                    </div>

                    <label>option</label>
                    <div><textarea class="w3-input" type="textarea" placeholder="option" id="up_option"
                            required></textarea>
                        <button class="w3-bar w3-green" onclick="up_option()">M</button>
                    </div>



                </div>

                <button onclick="hidden_nodel('update')">stop Update</button>
            </div>
        </div>
    </div>
    </div>

    <div id="info">

    </div>

    <div id="data">

    </div>
    


</body>

<script>
    var myAirtable;
    var myAirtableSpy;
    var myapiJS;

    let table = "table1";

    var update_id = undefined;
    var confirm_sup = false;



    function b_add() {
        //titre // add_option // lien
        const titre = document.getElementById("titre").value;
        const add_option = document.getElementById("add_option").value;
        const lien = document.getElementById("lien").value;
        myAirtable.addAirtable([{ 'fields': { 'Name': titre, 'urls': lien, 'option': add_option } }]).then(log);
    }

    function b_search() {
        option = document.getElementById("search").value;
        andor = document.getElementById("andor").value;
        sort = document.getElementById("sort").value;
        tab = option.split("\n");
        var s = "";
        for (var i = 0; i < tab.length; i++) {
            if (i > 0) s += ",";
            s += "FIND(\'" + tab[i] + "\',option)";
        }
        if (tab.length > 1) {
            s = andor + "(" + s + ")";
        }
        myAirtable.getAirtable(null, "filterByFormula=" + s + "&sort%5B0%5D%5Bfield%5D=Last Modified&sort%5B0%5D%5Bdirection%5D=" + sort + "&pageSize=10&pageSize=10").then(print_table);
    }



    function one() {
        myAirtable.getAirtable(null, 'pageSize=1').then(print_table);
    }

    function f_all() {
        myAirtable.getAirtable(null, "pageSize=10").then(print_table);
    }


    function my_sort(sort) {
        myAirtable.getAirtable(null, "sort%5B0%5D%5Bfield%5D=Last Modified&sort%5B0%5D%5Bdirection%5D=" + sort + "&pageSize=10").then(print_table);
    }

    function print_table(rep) {
        if (rep.records.length >= 1) {
            table_header = "<tr>";


            table_header += "<th>Name</th>";
            table_header += "<th>urls</th>";
            table_header += "<th>option</th>";
            //table_header += "<th> createdTime </th>";

            table_header += "<th>Last Modified</th>";
            table_header += "<th> update </th>";
            table_header += "<th> suprime </th>";
            table_header += "</tr>";
            contenu = "";
            rep.records.forEach(element => {
                contenu += "<tr title=" + element.id + " id=" + element.id + " >";

                contenu += "<td class=titre value=\"" + element.fields.Name + "\">";
                contenu += many_title(element.fields.Name);
                contenu += "</td>";

                contenu += "<td class=lien value=\"" + element.fields.urls + "\">";
                contenu += many_link(element.fields.urls);
                contenu += "</td>";


                contenu += "<td  class=option value=\"" + element.fields.option + "\">";
                contenu += element.fields.option;
                contenu += "</td>";
                /*
                contenu += "<td>";
                contenu += element.createdTime;
                contenu += "</td>";
                */
                contenu += "<td class=\"last_modif\">";
                contenu += element.fields['Last Modified'].replace(":", ":<pre>");
                contenu += "</td>";
                contenu += "<td>";
                contenu += "<button onclick=\"update('" + element.id + "')\">M</button>";
                contenu += "</td>";

                contenu += "<td>";
                contenu += "<button onclick=\"sup('" + element.id + "','" + element.fields.Name.split("\n")[0].replace(/[',"]/g, "\\'") + "')\">M</button>";
                contenu += "</td>";

                contenu += "</tr>";

            });
            if (rep.offset != null) {
                my_next = "<button onclick=\"next('" + rep.offset + "')\">next</button>";
            } else {
                my_next = "";
            }
            document.getElementById('data').innerHTML = "<table>" + table_header + contenu + "</table>" + my_next + "<h3>count=" + rep.records.length + "</h3>";
        } else {
            document.getElementById('data').innerHTML = "<h3>NO FOUND</h3>"
        }
    }

    function update(id) {
        update_id = id;
        document.getElementById("up_id").innerHTML = id;
        show_nodel("update")
        titre = document.getElementById(id).getElementsByClassName("titre")[0].attributes[1].value;
        document.getElementById("up_titre").value = titre;
        lien = document.getElementById(id).getElementsByClassName("lien")[0].attributes[1].value;
        document.getElementById("up_lien").value = lien;
        option = document.getElementById(id).getElementsByClassName("option")[0].attributes[1].value;
        document.getElementById("up_option").value = option;
        //myAirtable.updateAirtable([{'id':id,'fields':{ 'Name': titre, 'urls': lien, 'option': add_option }}]).then(log);
    }

    function up_titre() {
        titre = document.getElementById("up_titre").value;
        myAirtable.updateAirtable([{ 'id': update_id, 'fields': { 'Name': titre } }]).then(log);
    }
    function up_lien() {
        lien = document.getElementById("up_lien").value;
        myAirtable.updateAirtable([{ 'id': update_id, 'fields': { 'urls': lien } }]).then(log);
    }
    function up_option() {
        option = document.getElementById("up_option").value;
        myAirtable.updateAirtable([{ 'id': update_id, 'fields': { 'option': option } }]).then(log);
    }

    function up_stop() {
        document.getElementById("update").hidden = true;
    }

    function sup(id, titre) {
        const titre0 = titre.split("\n")[0];
        if (confirm("Confirmé la supression de " + titre0) == true) {
            myAirtable.deleteAirtable([id]).then(log);
        }
    }

    function log(rep) {
        document.getElementById('info').innerHTML = JSON.stringify(rep);
    }
    function next(offset) {
        myAirtable.getAirtable(null, 'offset=' + offset).then(print_table);
    }

    function many_link(urls) {
        const tab = urls.split("\n");
        var s = "";
        for (var i = 0; i < tab.length; i++) {
            s += "*<a href=" + tab[i] + " target=\"_blank\" >" + tab[i] + "</a></br>";
        }
        return s;
    }
    function many_title(titles) {
        const tab = titles.split("\n");
        var s = "";
        for (var i = 0; i < tab.length; i++) {
            s += tab[i] + "</br>";
        }
        return s;
    }



    function connection() {
        login = document.getElementById("login").value;
        mdp = document.getElementById("mdp").value;
        myAirtable = new ApiAirtable(login, table, mdp);
        localStorage.setItem("login", login);
        localStorage.setItem("mdp", mdp);
        hidden_nodel("co");
    }

    if ((login = localStorage.getItem("login")) != null && (mdp = localStorage.getItem("mdp")) != null) {
        myAirtable = new ApiAirtable(login, table, mdp);
        myAirtableSpy = new ApiAirtable(login, "spy", mdp);
        myapiJS = new ApiClient();
        /* try {
             
             myapiJS.get("http://ip-api.com/json/", null, true).then(function (json) {
                 ip = json.query;
                 info = "city:" + json.city + " region" + json.regionName + " org:" + json.org + " navi:" + navigator.userAgent;
                 myAirtableSpy.addAirtable([{ 'fields': { 'info': info, 'IP': ip } }]);
             }, function (err) {
                 ip = "" + err;
                 info = " navi:" + navigator.userAgent;
                 myAirtableSpy.addAirtable([{ 'fields': { 'info': info, 'IP': ip } }]);
             });
             
         } catch (error) {
             myAirtableSpy.addAirtable([{ 'fields': { 'info': "navi:"+navigator.userAgent, 'IP': "err" } }]);
         }
         */
        myAirtableSpy.addAirtable([{ 'fields': { 'info': "navi:"+navigator.userAgent, 'IP': "vide" } }]);

        //myAirtableSpy.addAirtable([{ 'fields': { 'info': titre, 'IP': lien} }]).then(log);
        hidden_nodel("co");
    }

    //bookmanga.html

    //sessionStorage.setItem("lastname", "Smith");
    //sessionStorage.getItem("lastname");

    //localStorage.setItem("lastname", "Smith");
    //localStorage.getItem("lastname");

    //nodel
    function show_nodel(id) {
        document.getElementById(id).style.display = 'block';
    }

    function hidden_nodel(id) {
        document.getElementById(id).style.display = 'none';
    }

    function reset(id) {
        var list = document.getElementById(id).getElementsByClassName("erasable");;
        for (i = 0; i < list.length; i++) {
            list[i].value = "";
        }
    }


</script>

</html>